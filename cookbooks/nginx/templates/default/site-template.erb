# Generated by Chef for <%= node['fqdn'] %>
# Do NOT modify this file by hand.
#

<% unless @upstream.nil? || @upstream.empty? -%>
<% @upstream.each do |name, hash| -%>
upstream <%= name %> {
  <% if hash.fetch('server', nil).kind_of?(Array) -%>
  <% hash.fetch('server').each do |serv| -%>
  server <%= serv %>;
  <% end -%>
  <% else -%>
  server <%= hash.fetch('server') %>;
  <% end -%>

  <% if hash.fetch('options', nil).kind_of?(Array) -%>
  <% hash.fetch('options').each do |option| -%>
  <%= option %>;
  <% end -%>
  <% else -%>
  <%= hash.fetch('options') %>;
  <% end -%>
}
<% end -%>
<% end -%>

<% unless @server.nil? || @server.empty? -%>
# <%= @name %>
server {
  <% @server.fetch('listen').each do |listener| %>
  listen <%= listener %>;
  <% end %>

  server_name <%= @server.fetch('server_name').join(' ') %>;
  <% if @server.fetch('extra_options', nil).nil? || !@server.fetch('extra_options', nil).has_key?('root') -%>
  root /usr/share/nginx/html;
  <% end -%>

  <% unless @server.fetch('ssl', nil).nil? || @server.fetch('ssl', nil).empty? -%>
  <% @server.fetch('ssl').each do |key, value| -%>
  <%= key %> <%= value %>;
  <% end -%>
  <% end -%>

  <% unless @server.fetch('includes', nil).nil? || @server.fetch('includes', nil).empty? -%>
  <% @server.fetch('includes').each do |include| -%>
  include <%= include %>;
  <% end -%>
  <% end -%>

  <% unless @server.fetch('extra_options', nil).nil? || @server.fetch('extra_options', nil).empty? -%>
  <% @server.fetch('extra_options').each do |key, value| -%>
  <% if value.kind_of?(Array) -%>
  <% value.each do | val | -%>
  <%= key %> <%= val %>;
  <% end -%>
  <% else -%>
  <%= key %> <%= value %>;
  <% end -%>
  <% end -%>
  <% end -%>

  <% unless @server.fetch('locations', nil).nil? || @server.fetch('locations', nil).empty? -%>
  <% @server.fetch('locations').each do |location, options| -%>
  location <%= location %> {
    <% unless options.nil? || options.empty? -%>
    <% options.fetch('options').each do |option| -%>
    <%= option %>;
    <% end -%>
    <% end -%>
  }
  <% end -%>
  <% end -%>

  <% if @server.fetch('access_log', nil).nil? || @server.fetch('access_log', nil).empty? -%>
  access_log /var/log/nginx/site-<%= @server.fetch('server_name').first %>/access-$year-$month-$day.log;
  <% else -%>
  access_log <%= @server.fetch('access_log') %>
  <% end -%>
  <% if @server.fetch('error_log', nil).nil? || @server.fetch('error_log', nil).empty? -%>
  error_log /var/log/nginx/site-<%= @server.fetch('server_name').first %>/error.log;
  <% else -%>
  error_log <%= @server.fetch('error_log') %>
  <% end -%>
}
<% end -%>

<% unless @map.nil? || @map.empty? -%>
<% @map.each do |vars, hash| -%>
map <%= vars %> {
<% hash.fetch('options').each do |option| -%>
  <%= option %>;
<% end -%>
}
<% end -%>
<% end -%>
